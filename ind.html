<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Guided Meditation Timer | Relax & Focus</title>
    <meta
      name="description"
      content="A relaxing guided meditation timer with a calming video background, accessible controls, and friendly overlays to help you focus and unwind."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Rounded, relaxing font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        font-family: "Quicksand", Arial, sans-serif;
      }

      /* iOS-specific video fixes */
      .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: -1;
      }

      .video-background video {
        position: absolute;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        transform: translateX(-50%) translateY(-50%);
        object-fit: cover;
      }

      /* iOS-specific inline video fixes */
      video {
        /* Prevents the fullscreen video UI on iOS */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        /* Prevents the play button from appearing */
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      }

      /* Force the video to behave as a background on iOS */
      video::-webkit-media-controls {
        display: none !important;
      }

      video::-webkit-media-controls-enclosure {
        display: none !important;
      }

      video::-webkit-media-controls-panel {
        display: none !important;
      }

      video::-webkit-media-controls-play-button {
        display: none !important;
      }

      video::-webkit-media-controls-start-playback-button {
        display: none !important;
      }

      /* Timer container */
      .timer {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 320px;
        height: 320px;
      }

      .progress-ring {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: rotate(-90deg); /* Start progress at top */
      }

      .progress-ring__circle {
        stroke: white;
        transition: stroke-dasharray 0.3s linear, stroke-dashoffset 1s linear;
      }

      .time-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 5em;
        color: white;
        font-family: "Quicksand", Arial, sans-serif;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Button styles */
      .btn {
        position: fixed;
        z-index: 20;
        background: rgba(255, 255, 255, 0.85);
        color: #333;
        font-family: "Quicksand", Arial, sans-serif;
        font-size: 1.2em;
        border-radius: 2em;
        padding: 0.5em 1.3em;
        min-width: 8.5em;
        min-height: 2.5em;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: background 0.3s, color 0.3s;
        letter-spacing: 0.04em;
        border: none;
        outline: none;
        cursor: pointer;
        display: inline-block;
        text-align: center;
        white-space: nowrap;
      }

      .btn:hover {
        background: #e0e0e0;
        color: #111;
      }

      .exit-btn {
        top: 24px;
        left: 24px;
      }

      .toggle-btn {
        top: 24px;
        right: 24px;
      }

      .start-btn {
        font-size: 1.3em;
        padding: 0.7em 2.2em;
        border-radius: 2em;
        border: none;
        background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
        color: #232526;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
        font-weight: 700;
        letter-spacing: 0.04em;
        margin-top: 0.5em;
      }

      .start-btn:hover {
        background: linear-gradient(90deg, #38d769 0%, #2de0c2 100%);
      }

      /* Media queries for mobile optimization */
      @media screen and (max-width: 768px) {
        .timer {
          width: 280px;
          height: 280px;
        }

        .time-text {
          font-size: 4em;
        }

        .btn {
          font-size: 1em;
          min-width: 7em;
          padding: 0.4em 1em;
        }

        .exit-btn,
        .toggle-btn {
          top: 16px;
        }

        .exit-btn {
          left: 16px;
        }

        .toggle-btn {
          right: 16px;
        }
      }

      @media screen and (max-width: 480px) {
        .timer {
          width: 240px;
          height: 240px;
        }

        .time-text {
          font-size: 3.5em;
        }

        .btn {
          font-size: 0.9em;
          min-width: 6em;
          padding: 0.35em 0.9em;
        }
      }
    </style>
  </head>
  <body>
    <main id="main-content" tabindex="-1" aria-label="Meditation Timer Session">
      <!-- Exit button -->
      <button
        id="exit-btn"
        class="btn exit-btn"
        aria-label="Exit to main page"
        onclick="window.location.href='index.html'"
      >
        ⟵ Exit
      </button>

      <!-- Hide/Show Timer button -->
      <button
        id="toggle-timer-btn"
        class="btn toggle-btn"
        aria-controls="timer-container"
        aria-pressed="true"
        aria-label="Hide timer"
      >
        Hide Timer
      </button>

      <!-- Your video background with iOS optimizations -->
      <div class="video-background">
        <video
          id="bg-video"
          autoplay
          muted
          loop
          playsinline
          webkit-playsinline
          preload="auto"
          aria-label="Calming background video"
          tabindex="-1"
        >
          <source id="bg-video-source" src="mov.mp4" type="video/mp4" />
          <track
            kind="descriptions"
            src=""
            srclang="en"
            label="Video description"
          />
          Your browser does not support the video tag.
        </video>
      </div>

      <!-- Start Session overlay (required for audio autoplay) -->
      <div
        id="start-session-overlay"
        style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(0, 0, 0, 0.85);
          z-index: 100;
        "
      >
        <div
          style="
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2.5em;
            box-shadow: 0 8px 48px 0 rgba(0, 0, 0, 0.22);
            padding: 2.5em 2.5em 2em 2.5em;
            min-width: 340px;
            max-width: 95vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2.2em;
          "
        >
          <div
            style="
              font-size: 2.1em;
              font-weight: 700;
              color: #fff;
              letter-spacing: 0.03em;
              margin-bottom: 0.2em;
              text-align: center;
              font-family: 'Quicksand', Arial, sans-serif;
            "
          >
            Set Session Time
          </div>
          <div
            style="
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 1.2em;
              width: 100%;
            "
          >
            <label
              for="session-slider"
              style="
                font-size: 1.1em;
                color: #b0e6c1;
                font-weight: 600;
                letter-spacing: 0.02em;
                font-family: 'Quicksand', Arial, sans-serif;
              "
              >Minutes:
              <span
                id="slider-value"
                style="
                  color: #43e97b;
                  font-size: 1.2em;
                  font-family: 'Quicksand', Arial, sans-serif;
                "
                >10</span
              ></label
            >
            <input
              id="session-slider"
              type="range"
              min="1"
              max="90"
              value="10"
              style="width: 260px; accent-color: #43e97b; height: 2.2em"
            />
          </div>
          <button id="start-session-btn" class="start-btn">
            Start Session
          </button>
        </div>
      </div>

      <!-- Welcome, Gong, and Goodbye audio for start/end cues -->
      <audio id="welcome-audio" preload="auto">
        <source src="sounds/welcome.mp3" type="audio/mpeg" />
        Your browser does not support the audio element.
      </audio>
      <audio id="gong-audio" preload="auto">
        <source src="sounds/gong.mp3" type="audio/mpeg" />
        Your browser does not support the audio element.
      </audio>
      <audio id="goodbye-audio" preload="auto">
        <source src="sounds/goodbye.mp3" type="audio/mpeg" />
        Your browser does not support the audio element.
      </audio>

      <!-- Meditation overlays -->
      <div
        id="welcome-overlay"
        style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(0, 0, 0, 0.7);
          z-index: 10;
          opacity: 0;
          transition: opacity 2s;
        "
      >
        <div
          style="
            color: white;
            font-size: 3em;
            text-align: center;
            font-family: 'Quicksand', Arial, sans-serif;
            letter-spacing: 0.03em;
            max-width: 90vw;
          "
        >
          <div
            id="welcome-message-1"
            style="opacity: 0; transition: opacity 1.5s"
          >
            Welcome to your moment of calm.
          </div>
          <div
            id="welcome-message-2"
            style="opacity: 0; transition: opacity 1.5s; margin-top: 1em"
          >
            Let yourself settle and breathe deeply.
          </div>
          <div
            id="welcome-message-3"
            style="opacity: 0; transition: opacity 1.5s; margin-top: 1em"
          >
            Your session is starting now.<br />Let go and be present.
          </div>
        </div>
      </div>

      <!-- Timer overlay -->
      <section
        class="timer"
        id="timer-container"
        aria-live="polite"
        aria-label="Meditation Timer"
        style="
          opacity: 0;
          transition: opacity 1.5s;
          visibility: visible;
          min-height: 320px;
          min-width: 320px;
        "
        tabindex="0"
        role="region"
        aria-hidden="false"
      >
        <svg class="progress-ring" width="320" height="320">
          <circle
            class="progress-ring__circle-bg"
            stroke-width="18"
            fill="transparent"
            r="150"
            cx="160"
            cy="160"
          />
          <circle
            class="progress-ring__circle"
            stroke-width="18"
            fill="transparent"
            r="150"
            cx="160"
            cy="160"
          />
        </svg>
        <div
          class="time-text"
          id="time"
          aria-live="polite"
          aria-atomic="true"
          role="status"
        >
          60
        </div>
      </section>

      <!-- Goodbye overlay -->
      <div
        id="goodbye-overlay"
        style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(0, 0, 0, 0.7);
          z-index: 10;
          opacity: 0;
          transition: opacity 3s;
          pointer-events: none;
        "
      >
        <div
          style="
            color: white;
            font-size: 3em;
            text-align: center;
            font-family: 'Quicksand', Arial, sans-serif;
            letter-spacing: 0.03em;
            max-width: 90vw;
          "
        >
          <div>
            I'm glad you took this time for yourself.<br />
            Hold this quiet space in your heart.<br />
            Whenever you're ready, gently return.
          </div>
        </div>
      </div>

      <script>
        // iOS video optimization
        function isIOS() {
          return (
            /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream
          );
        }

        // Set background video from URL parameter if present
        (function () {
          function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
          }
          const videoParam = getQueryParam("video");
          if (videoParam) {
            const video = document.getElementById("bg-video");
            const source = document.getElementById("bg-video-source");
            if (video && source) {
              source.src = videoParam;
              video.load();
            }
          }

          // Additional iOS video optimizations
          if (isIOS()) {
            const video = document.getElementById("bg-video");

            // Force inline playback
            video.setAttribute("playsinline", "true");
            video.setAttribute("webkit-playsinline", "true");

            // Prevent the video from seeking ahead to preload
            video.preload = "auto";

            // Handle potential autoplay restrictions
            const playVideo = () => {
              video.play().catch((e) => {
                console.log("Autoplay prevented:", e);
                // If autoplay is prevented, show a play button overlay
                showPlayButtonOverlay();
              });
            };

            // Try to play the video after user interaction
            document.addEventListener(
              "click",
              function () {
                playVideo();
              },
              { once: true }
            );

            // Also try to play on page load
            window.addEventListener("load", playVideo);
          }
        })();

        function showPlayButtonOverlay() {
          // Create a play button overlay if autoplay is blocked
          const playOverlay = document.createElement("div");
          playOverlay.style.position = "fixed";
          playOverlay.style.top = "0";
          playOverlay.style.left = "0";
          playOverlay.style.width = "100%";
          playOverlay.style.height = "100%";
          playOverlay.style.backgroundColor = "rgba(0,0,0,0.5)";
          playOverlay.style.display = "flex";
          playOverlay.style.justifyContent = "center";
          playOverlay.style.alignItems = "center";
          playOverlay.style.zIndex = "15";

          const playButton = document.createElement("button");
          playButton.innerHTML = "▶ Play Video";
          playButton.className = "btn start-btn";
          playButton.style.fontSize = "1.5em";
          playButton.style.padding = "1em 2em";
          playButton.onclick = function () {
            document.getElementById("bg-video").play();
            document.body.removeChild(playOverlay);
          };

          playOverlay.appendChild(playButton);
          document.body.appendChild(playOverlay);
        }

        // Hide/Show Timer Button Logic & Accessibility
        const toggleBtn = document.getElementById("toggle-timer-btn");
        const timerSection = document.getElementById("timer-container");
        let timerVisible = true;
        toggleBtn.addEventListener("click", function () {
          timerVisible = !timerVisible;
          timerSection.style.visibility = timerVisible ? "visible" : "hidden";
          timerSection.setAttribute(
            "aria-hidden",
            timerVisible ? "false" : "true"
          );
          toggleBtn.setAttribute(
            "aria-pressed",
            timerVisible ? "true" : "false"
          );
          toggleBtn.setAttribute(
            "aria-label",
            timerVisible ? "Hide timer" : "Show timer"
          );
          toggleBtn.textContent = timerVisible ? "Hide Timer" : "Show Timer";
          if (timerVisible) timerSection.focus();
        });

        let seconds = 600; // default 10 minutes
        const slider = document.getElementById("session-slider");
        const sliderValue = document.getElementById("slider-value");
        slider.addEventListener("input", () => {
          sliderValue.textContent = slider.value;
          seconds = parseInt(slider.value, 10) * 60;
        });

        // Initialize value
        sliderValue.textContent = slider.value;
        seconds = parseInt(slider.value, 10) * 60;

        const timeEl = document.getElementById("time");
        const progressCircle = document.querySelector(".progress-ring__circle");
        const radius = 150;
        const circumference = 2 * Math.PI * radius;
        progressCircle.setAttribute("stroke-dasharray", circumference);
        progressCircle.setAttribute("stroke-dashoffset", circumference);

        function setProgress(percent) {
          const offset = circumference - percent * circumference;
          progressCircle.setAttribute("stroke-dashoffset", offset);
        }

        function formatTime(secs) {
          const m = Math.floor(secs / 60);
          const s = secs % 60;
          return `${m}:${s.toString().padStart(2, "0")}`;
        }

        // Meditation overlay logic
        const welcomeOverlay = document.getElementById("welcome-overlay");
        const welcomeMsg1 = document.getElementById("welcome-message-1");
        const welcomeMsg2 = document.getElementById("welcome-message-2");
        const welcomeMsg3 = document.getElementById("welcome-message-3");
        const timerContainer = document.getElementById("timer-container");
        const goodbyeOverlay = document.getElementById("goodbye-overlay");

        // Sequence: Welcome1 -> Welcome2 -> Welcome3 -> Timer -> Goodbye
        function fadeIn(el) {
          el.style.opacity = 1;
        }
        function fadeOut(el) {
          el.style.opacity = 0;
        }

        // Helper to fade in, wait, then fade out a message
        function showMessage(msgEl, fadeInMs, visibleMs, fadeOutMs, next) {
          msgEl.style.opacity = 1;
          setTimeout(() => {
            msgEl.style.opacity = 0;
            setTimeout(next, fadeOutMs);
          }, visibleMs);
        }

        // Show overlays with slow fade in/out
        const gong = document.getElementById("gong-audio");
        const welcomeAudio = document.getElementById("welcome-audio");
        const startOverlay = document.getElementById("start-session-overlay");
        const startBtn = document.getElementById("start-session-btn");
        const goodbyeAudio = document.getElementById("goodbye-audio");

        function beginSessionSequence() {
          // Use slider value for timer
          seconds = parseInt(slider.value, 10) * 60;

          // Restart background video
          const bgVideo = document.getElementById("bg-video");
          if (bgVideo) {
            try {
              bgVideo.currentTime = 0;
              bgVideo.play();
            } catch (e) {
              console.error("Error playing video:", e);
            }
          }

          // Play welcome audio
          if (welcomeAudio) {
            try {
              welcomeAudio.currentTime = 0;
              welcomeAudio.play();
            } catch (e) {
              console.error("Error playing welcome audio:", e);
            }
          }

          startOverlay.style.display = "none";
          setTimeout(() => {
            welcomeOverlay.style.opacity = 1;
            // Fade in first message
            showMessage(
              welcomeMsg1,
              1200, // fade in ms (matches CSS)
              3000, // visible ms
              1200, // fade out ms
              () => {
                // Fade in second message
                showMessage(welcomeMsg2, 1200, 4500, 1800, () => {
                  // Fade in third message
                  showMessage(welcomeMsg3, 1200, 6000, 1200, () => {
                    // Fade out overlay, fade in timer
                    fadeOut(welcomeOverlay);
                    setTimeout(() => {
                      welcomeOverlay.style.display = "none";
                      timerContainer.style.opacity = 1;
                      // Play gong at session start
                      if (gong) {
                        try {
                          gong.currentTime = 0;
                          gong.play();
                        } catch (e) {
                          console.error("Error playing gong:", e);
                        }
                      }
                      startTimer();
                    }, 1500);
                  });
                });
              }
            );
          }, 100);
        }

        startBtn.addEventListener("click", beginSessionSequence);

        function startTimer() {
          setProgress(0); // Start empty
          let elapsed = 0;
          timeEl.textContent = formatTime(seconds);
          const interval = setInterval(() => {
            elapsed++;
            const remaining = seconds - elapsed;
            timeEl.textContent = formatTime(Math.max(remaining, 0));
            setProgress(elapsed / seconds);
            if (elapsed >= seconds) {
              clearInterval(interval);
              setProgress(1);
              timeEl.textContent = "0:00";
              // Show goodbye overlay
              setTimeout(() => {
                timerContainer.style.opacity = 0;
                setTimeout(() => {
                  // Play gong at session end
                  if (gong) {
                    try {
                      gong.currentTime = 0;
                      gong.play();
                    } catch (e) {
                      console.error("Error playing gong:", e);
                    }
                  }
                  goodbyeOverlay.style.opacity = 1;
                  // Play goodbye.mp3 a few seconds after the end gong
                  setTimeout(() => {
                    if (goodbyeAudio) {
                      try {
                        goodbyeAudio.currentTime = 0;
                        goodbyeAudio.play();
                      } catch (e) {
                        console.error("Error playing goodbye audio:", e);
                      }
                    }
                  }, 2500); // 2.5s after overlay appears
                }, 2000);
              }, 2000);
            }
          }, 1000);
        }
      </script>
    </main>
    <!-- Landmarks for accessibility -->
    <nav aria-label="Main Navigation" style="display: none"></nav>
    <footer aria-label="Footer" style="display: none"></footer>
  </body>
</html>
